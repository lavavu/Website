<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>LavaVu Emscripten</title>

    <script type="text/javascript" src="dat.gui.min.js"></script>
    <script type="text/javascript" src="OK-min.js"></script>

    <link rel="stylesheet" type="text/css" href="emscripten.css">
    <link rel="stylesheet" type="text/css" href="control.css">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" type="text/css" href="gui.css">
    <!--link rel="stylesheet" type="text/css" href="dat-gui-light-theme.css"-->
  </head>
  <body>

    <div class="spinner" id='spinner' style="z-index: 100; position: relative;"></div>
    <div class="emscripten" id="status" style="z-index: 100; position: relative;">Downloading...</div>

    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1 style="z-index: 100; position: relative;"></progress>
    </div>
    
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
    <textarea id="output" rows="20"></textarea>

    <input id="fileinput" type="file" style="visibility:hidden" onchange="useFileInput(this)" />

    <script type="text/javascript" src="baseviewer.js"></script>
    <script type="text/javascript" src="menu.js"></script>
    <script type="text/javascript" src="emscripten.js"></script>

    <script async type="text/javascript" src="LavaVu.js"></script>

    <script type="text/javascript">
      //Flag window resize
      window.onresize = function() {
        window.resized = true;
        clear_mods();
      };

      //Hack for firefox to fix mod key state bugs in emscripten glfw
      window.set_mods = function(e) {
        window.m_alt = e.getModifierState('Alt');
        window.m_shift = e.getModifierState('Shift');
        window.m_ctrl = e.getModifierState('Control');
        //console.log(e.key + " ALT: " + window.m_alt + " SHIFT: " + window.m_shift + " CTRL: " + window.m_ctrl);
      }
      window.clear_mods = function() {
        window.m_alt = false;
        window.m_shift = false;
        window.m_ctrl = false;
        //console.log(" ALT: " + window.m_alt + " SHIFT: " + window.m_shift + " CTRL: " + window.m_ctrl);
      }
      window.onkeydown = function(e){
        set_mods(e);
      }
      window.onkeyup = function(e){
        set_mods(e);
      }

      //Switch the theme, called when background changed
      var light_theme = "dat-gui-light-theme.css";

      window.set_light_theme = function(enabled) {
        for (var i = 0; i < document.styleSheets.length; i++) {
          var href = document.styleSheets[i].href;
          if (href && href.includes(light_theme)) {
            document.styleSheets[i].disabled = !enabled;
            return;
          }
        }

        //If we reach here, light theme is not loaded, add it
        if (enabled) {
          var head = document.getElementsByTagName("head")[0];
          var fileref = document.createElement("link")
          fileref.setAttribute("rel", "stylesheet")
          fileref.setAttribute("type", "text/css")
          fileref.setAttribute("href", light_theme)
          head.appendChild(fileref);
        }
      }

      // https://stackoverflow.com/questions/47313403/passing-client-files-to-webassembly-from-the-front-end
      function useFileInput(fileInput) {
        if (fileInput.files.length == 0)
          return;
        //TODO: support multiple?
        var file = fileInput.files[0];

        var fr = new FileReader();
        fr.onload = function () {
          var data = new Uint8Array(fr.result);

          Module['FS_createDataFile']('/', file.name, data, true, true, true);
          window.commands = "file " + file.name;

          fileInput.value = '';
        };
        fr.readAsArrayBuffer(file);
      }

    </script>
  </body>
</html>


